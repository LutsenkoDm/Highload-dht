Сервер, wrk и async-profiler запускались через wsl

Нагрузочное тестирование запускалось со следующими параметрами:
  -Длительность 60 секунд
  -Число потоков 1
  -Число соединений 1
  -Rate 5000 для PUT запросов и 2500 для GET

Параметр flushThresholdBytes в dao равен 1 МБ

//---------------------------------------------------PUT---------------------------------------------------\\

```
./wrk -d 60 -t 1 -c 1 -R 5000 -L -s ./wrk-scripts/stage1_PUT.lua http://localhost:19234
Running 1m test @ http://localhost:19234
1 threads and 1 connections
Thread calibration: mean lat.: 4.305ms, rate sampling interval: 10ms
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency   835.16us    0.97ms  14.09ms   97.19%
Req/Sec     5.29k   515.11    11.56k    73.59%
Latency Distribution (HdrHistogram - Recorded Latency)
50.000%  721.00us
75.000%    1.01ms
90.000%    1.18ms
99.000%    6.00ms
99.900%   11.77ms
99.990%   13.45ms
99.999%   14.07ms
100.000%   14.10ms

    Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.070     0.000000            1         1.00
       0.258     0.100000        25169         1.11
       0.374     0.200000        50115         1.25
       0.490     0.300000        75064         1.43
       0.606     0.400000       100144         1.67
       0.721     0.500000       125025         2.00
       0.779     0.550000       137683         2.22
       0.836     0.600000       150099         2.50
       0.893     0.650000       162534         2.86
       0.951     0.700000       175207         3.33
       1.007     0.750000       187506         4.00
       1.036     0.775000       193820         4.44
       1.064     0.800000       200040         5.00
       1.092     0.825000       206278         5.71
       1.121     0.850000       212641         6.67
       1.149     0.875000       218924         8.00
       1.163     0.887500       222019         8.89
       1.177     0.900000       225135        10.00
       1.191     0.912500       228311        11.43
       1.204     0.925000       231248        13.33
       1.219     0.937500       234454        16.00
       1.226     0.943750       235960        17.78
       1.236     0.950000       237483        20.00
       1.275     0.956250       239034        22.86
       1.400     0.962500       240604        26.67
       1.650     0.968750       242158        32.00
       1.806     0.971875       242940        35.56
       1.997     0.975000       243724        40.00
       2.295     0.978125       244501        45.71
       3.179     0.981250       245285        53.33
       4.107     0.984375       246066        64.00
       4.531     0.985938       246458        71.11
       5.079     0.987500       246846        80.00
       5.599     0.989062       247237        91.43
       6.195     0.990625       247629       106.67
       6.875     0.992188       248018       128.00
       7.279     0.992969       248212       142.22
       7.571     0.993750       248408       160.00
       8.067     0.994531       248604       182.86
       8.575     0.995313       248799       213.33
       9.223     0.996094       248993       256.00
       9.495     0.996484       249092       284.44
       9.823     0.996875       249190       320.00
      10.167     0.997266       249286       365.71
      10.503     0.997656       249384       426.67
      10.703     0.998047       249482       512.00
      10.879     0.998242       249530       568.89
      11.103     0.998437       249579       640.00
      11.327     0.998633       249628       731.43
      11.559     0.998828       249679       853.33
      11.783     0.999023       249728      1024.00
      11.967     0.999121       249750      1137.78
      12.175     0.999219       249774      1280.00
      12.407     0.999316       249800      1462.86
      12.639     0.999414       249824      1706.67
      12.871     0.999512       249847      2048.00
      12.951     0.999561       249860      2275.56
      13.031     0.999609       249872      2560.00
      13.087     0.999658       249885      2925.71
      13.135     0.999707       249898      3413.33
      13.215     0.999756       249908      4096.00
      13.287     0.999780       249916      4551.11
      13.343     0.999805       249922      5120.00
      13.383     0.999829       249927      5851.43
      13.407     0.999854       249933      6826.67
      13.431     0.999878       249939      8192.00
      13.447     0.999890       249943      9102.22
      13.463     0.999902       249945     10240.00
      13.487     0.999915       249949     11702.86
      13.511     0.999927       249951     13653.33
      13.567     0.999939       249954     16384.00
      13.607     0.999945       249956     18204.44
      13.631     0.999951       249959     20480.00
      13.631     0.999957       249959     23405.71
      13.687     0.999963       249960     27306.67
      13.791     0.999969       249962     32768.00
      13.847     0.999973       249963     36408.89
      13.847     0.999976       249963     40960.00
      13.911     0.999979       249964     46811.43
      13.967     0.999982       249965     54613.33
      14.015     0.999985       249966     65536.00
      14.015     0.999986       249966     72817.78
      14.015     0.999988       249966     81920.00
      14.071     0.999989       249967     93622.86
      14.071     0.999991       249967    109226.67
      14.095     0.999992       249969    131072.00
      14.095     1.000000       249969          inf
```
Среднее время обработки запроса составляет 835.16 us, максимальное - 14.09 ms.
В 90% случаев время запроса не превышает 1.18ms, а в 99% - 6.00ms, что можно считать стабильной нагрузкой.

CPU:
    Из результатов профилирования следует, что обработка запроса (one.nio.net.Session.process) занимает 85.96%
    процессорного времени, из которых: 2.48% - выполнение метода upsert в dao, большая часть времени уходит 
    на работу с сетью: RequestHandler1_handlePut.handleRequest - 68.18% и 3% на парсинг HttpBuffer, нативный метод
    one.nio.net.NativeSocket.read - 9.72%.
    Также 0.74% занимает запись данных на диск (flush). 
    Остальное время отводится на native код, в основном: one.nio.net.NativeSelector.epollWait () - 12.55%, 
    возвращающий количество дескрипторов, у которых поменялось состояние (готовы к вводу-выводу) и
    one.nio.net.Session.read - 8.8% для чтения данных из сокета в буфер. 
    Из результатов профилирования следует, что большая часть процессорного времени уходит на работу с сетью, 
    в то время как dao занимает менее 3% времени. Таким образом следует оптимизировать именно работу с сетью, так как
    она занимает почти все процессорное время. 

Alloc:
    9.47% отводится на перевод массива байт в строку, связано с тем, что используется dao на строках
    15.57% на перевод вставляемого value в строку в методе handlePut из DemoService
    13.36% для записи на диск в dao
    Остальное - для обработки запроса с помощью one.nio (Парсинг самого запроса: параметры, тело, path и т.д.,
    чтение и парсинг HttpBuffer в строковое представление с помощью one.nio.util.Utf8.toAsciiString,
    перевод ответа Response в массив байт для его отправки) - более 60% аллокаций.

//---------------------------------------------------GET---------------------------------------------------\\


```
 ./wrk -d 60 -t 1 -c 1 -R 2500 -L -s ./wrk-scripts/stage1_GET.lua http://localhost:19234
Running 1m test @ http://localhost:19234
  1 threads and 1 connections
  Thread calibration: mean lat.: 2.317ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.13ms  542.12us   4.79ms   60.60%
    Req/Sec     2.65k   251.31     3.56k    69.75%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.11ms
 75.000%    1.56ms
 90.000%    1.86ms
 99.000%    2.24ms
 99.900%    3.25ms
 99.990%    4.25ms
 99.999%    4.65ms
100.000%    4.79ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.171     0.000000            1         1.00
       0.403     0.100000        12514         1.11
       0.579     0.200000        25059         1.25
       0.757     0.300000        37567         1.43
       0.934     0.400000        50052         1.67
       1.108     0.500000        62528         2.00
       1.194     0.550000        68818         2.22
       1.281     0.600000        75048         2.50
       1.370     0.650000        81266         2.86
       1.462     0.700000        87520         3.33
       1.557     0.750000        93777         4.00
       1.604     0.775000        96929         4.44
       1.652     0.800000       100036         5.00
       1.702     0.825000       103184         5.71
       1.748     0.850000       106252         6.67
       1.800     0.875000       109384         8.00
       1.830     0.887500       110947         8.89
       1.862     0.900000       112495        10.00
       1.894     0.912500       114068        11.43
       1.926     0.925000       115642        13.33
       1.960     0.937500       117205        16.00
       1.976     0.943750       117980        17.78
       1.993     0.950000       118751        20.00
       2.013     0.956250       119546        22.86
       2.032     0.962500       120302        26.67
       2.053     0.968750       121088        32.00
       2.071     0.971875       121516        35.56
       2.089     0.975000       121872        40.00
       2.113     0.978125       122278        45.71
       2.139     0.981250       122662        53.33
       2.169     0.984375       123071        64.00
       2.185     0.985938       123245        71.11
       2.205     0.987500       123431        80.00
       2.225     0.989062       123635        91.43
       2.249     0.990625       123840       106.67
       2.271     0.992188       124017       128.00
       2.285     0.992969       124127       142.22
       2.299     0.993750       124213       160.00
       2.317     0.994531       124311       182.86
       2.343     0.995313       124404       213.33
       2.389     0.996094       124504       256.00
       2.421     0.996484       124552       284.44
       2.461     0.996875       124599       320.00
       2.535     0.997266       124648       365.71
       2.635     0.997656       124698       426.67
       2.775     0.998047       124745       512.00
       2.863     0.998242       124770       568.89
       2.959     0.998437       124794       640.00
       3.059     0.998633       124819       731.43
       3.167     0.998828       124843       853.33
       3.263     0.999023       124868      1024.00
       3.335     0.999121       124880      1137.78
       3.421     0.999219       124892      1280.00
       3.501     0.999316       124904      1462.86
       3.587     0.999414       124917      1706.67
       3.675     0.999512       124928      2048.00
       3.697     0.999561       124935      2275.56
       3.763     0.999609       124941      2560.00
       3.803     0.999658       124947      2925.71
       3.859     0.999707       124953      3413.33
       3.939     0.999756       124960      4096.00
       3.997     0.999780       124962      4551.11
       4.025     0.999805       124965      5120.00
       4.085     0.999829       124968      5851.43
       4.115     0.999854       124971      6826.67
       4.175     0.999878       124974      8192.00
       4.243     0.999890       124976      9102.22
       4.247     0.999902       124977     10240.00
       4.275     0.999915       124979     11702.86
       4.335     0.999927       124980     13653.33
       4.439     0.999939       124982     16384.00
       4.447     0.999945       124983     18204.44
       4.447     0.999951       124983     20480.00
       4.507     0.999957       124985     23405.71
       4.507     0.999963       124985     27306.67
       4.619     0.999969       124987     32768.00
       4.619     0.999973       124987     36408.89
       4.619     0.999976       124987     40960.00
       4.619     0.999979       124987     46811.43
       4.619     0.999982       124987     54613.33
       4.651     0.999985       124988     65536.00
       4.651     0.999986       124988     72817.78
       4.651     0.999988       124988     81920.00
       4.651     0.999989       124988     93622.86
       4.651     0.999991       124988    109226.67
       4.791     0.999992       124989    131072.00
       4.791     1.000000       124989          inf
```

Среднее время обработки запроса составляет 1.13 ms, максимальное - 4.79 ms.
В 90% случаев время запроса не превышает 1.86 ms, а в 99% - 2.24 ms, что можно считать стабильной нагрузкой.
Стоит учитывать, что некоторые элементы находятся в памяти, что ускоряет скорость доступа к ним.
Также отсутствуют вызовы метода compact, соответственно с ростом числа файлов с данными на диске, скорость 
поиска уменьшается.

CPU:
    Из результатов профилирования следует, что обработка запроса (one.nio.net.Session.process) занимает 85.71%
    процессорного времени, из которых 26.7% - выполнение метода get в dao, где большая часть времени уходит
    на бинарный поиск - 21%, остальное на инициализацию и работу с MergeIterator.
    Работа с сетью: RequestHandler1_handlePut.handleRequest - 45.17% и 2.5% на парсинг HttpBuffer.
    Остальное время отводится на native код, в основном: one.nio.net.NativeSelector.epollWait - 10.67%,
    возвращающий количество дескрипторов, у которых поменялось состояние (готовы к вводу-выводу) и
    one.nio.net.Session.read - 8% для чтения данных из сокета в буфер.
    Возможные решения для увеличения производительности в данном случае - добавить вызовы
    compact в автоматическом или ручном режиме, оптимизировать бинарный поиск.

Alloc:
    94.98% отводится на выполнение метода get в dao
    из них:
        12.5% на создание MergeIterator
        34.25% на чтение value (22.42% на перевод в строку)
        29.86% на чтение key (29.86% на перевод в строку)
        14.76% на бинарный поиск
    Возможные решения для оптимизации: улучшение использования памяти в бинарном поиске и MergeIterator.
    Также увеличение параметра flushThresholdBytes в dao увеличит размер таблиц на диске, 
    что уменьшит количество файлов для поиска. 

Подробные результаты профилирования(heatmap) находятся в папке /reports/async-profiler
    
    

